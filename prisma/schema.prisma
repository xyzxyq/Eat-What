generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model CoupleSpace {
  id                String              @id @default(uuid())
  passphraseHash    String              @unique
  inviteCode        String?             @unique
  startDate         DateTime?
  theme             String              @default("yellow")
  effectIntensity   String              @default("subtle")
  effectArea        String              @default("local")
  createdAt         DateTime            @default(now())
  anniversaries     Anniversary[]
  dailyInteractions DailyInteraction[]
  foodChoices       FoodChoice[]
  foodLibraries     FoodLibrary[]
  foodOptions       FoodOption[]
  foodVoteSessions  FoodVoteSession[]
  missYouRecords    MissYou[]
  moments           Moment[]
  secretWishes      SecretWish[]
  users             User[]
  wishes            Wish[]
  revealRequests    WishRevealRequest[]
}

model User {
  id                         String              @id @default(uuid())
  nickname                   String
  displayName                String?
  passwordHash               String?
  gender                     String?
  avatarEmoji                String              @default("üíï")
  avatarUrl                  String?
  status                     String              @default("")
  isProfileComplete          Boolean             @default(false)
  email                      String?             @unique
  isEmailVerified            Boolean             @default(false)
  notifyOnMoment             Boolean             @default(false)
  notifyOnComment            Boolean             @default(false)
  notifyOnWish               Boolean             @default(false)
  notifyOnSecretWishRequest  Boolean             @default(true)
  notifyOnSecretWishResponse Boolean             @default(true)
  coupleSpaceId              String
  createdAt                  DateTime            @default(now())
  comments                   Comment[]
  dailyInteractions          DailyInteraction[]
  emailVerifications         EmailVerification[]
  missYouRecords             MissYou[]
  moments                    Moment[]
  reactions                  Reaction[]
  secretWishes               SecretWish[]
  coupleSpace                CoupleSpace         @relation(fields: [coupleSpaceId], references: [id])
  wishesCreated              Wish[]              @relation("WishCreator")
  wishesEdited               Wish[]              @relation("WishEditor")
  wishComments               WishComment[]
  revealRequestsSent         WishRevealRequest[] @relation("RevealRequester")
  revealRequestsReceived     WishRevealRequest[] @relation("RevealTarget")
  wishVotes                  WishVote[]

  @@unique([coupleSpaceId, nickname])
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, code])
}

model Moment {
  id            String      @id @default(uuid())
  content       String
  mediaUrl      String?
  mediaType     String      @default("none")
  likeCount     Int         @default(0)
  userId        String
  coupleSpaceId String
  momentDate    DateTime
  createdAt     DateTime    @default(now())
  comments      Comment[]
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  user          User        @relation(fields: [userId], references: [id])
  reactions     Reaction[]

  @@unique([userId, momentDate])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  momentId  String
  userId    String
  parentId  String?
  createdAt DateTime  @default(now())
  moment    Moment    @relation(fields: [momentId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  user      User      @relation(fields: [userId], references: [id])
}

model Reaction {
  id        String   @id @default(uuid())
  emoji     String
  momentId  String
  userId    String
  createdAt DateTime @default(now())
  moment    Moment   @relation(fields: [momentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([momentId, userId, emoji])
}

model Wish {
  id             String        @id @default(uuid())
  content        String
  isCompleted    Boolean       @default(false)
  coupleSpaceId  String
  createdById    String
  lastEditedById String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  coupleSpace    CoupleSpace   @relation(fields: [coupleSpaceId], references: [id])
  createdBy      User          @relation("WishCreator", fields: [createdById], references: [id])
  lastEditedBy   User?         @relation("WishEditor", fields: [lastEditedById], references: [id])
  comments       WishComment[]
  votes          WishVote[]
}

model WishVote {
  id        String   @id @default(uuid())
  wishId    String
  userId    String
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  wish      Wish     @relation(fields: [wishId], references: [id], onDelete: Cascade)

  @@unique([wishId, userId])
}

model WishComment {
  id        String        @id @default(uuid())
  content   String
  wishId    String
  userId    String
  parentId  String?
  createdAt DateTime      @default(now())
  parent    WishComment?  @relation("WishCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   WishComment[] @relation("WishCommentReplies")
  user      User          @relation(fields: [userId], references: [id])
  wish      Wish          @relation(fields: [wishId], references: [id], onDelete: Cascade)
}

model Anniversary {
  id            String      @id @default(uuid())
  title         String
  date          DateTime
  emoji         String      @default("üíï")
  type          String      @default("countdown")
  isRecurring   Boolean     @default(false)
  isPinned      Boolean     @default(false)
  sortOrder     Int         @default(0)
  coupleSpaceId String
  createdById   String
  createdAt     DateTime    @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
}

model SecretWish {
  id             String              @id @default(uuid())
  content        String
  emoji          String              @default("üéÅ")
  isRevealed     Boolean             @default(false)
  revealedAt     DateTime?
  coupleSpaceId  String
  createdById    String
  createdAt      DateTime            @default(now())
  coupleSpace    CoupleSpace         @relation(fields: [coupleSpaceId], references: [id])
  createdBy      User                @relation(fields: [createdById], references: [id])
  revealRequests WishRevealRequest[]
}

model WishRevealRequest {
  id            String      @id @default(uuid())
  secretWishId  String?
  requesterId   String
  targetUserId  String
  status        String      @default("pending")
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  requester     User        @relation("RevealRequester", fields: [requesterId], references: [id])
  secretWish    SecretWish? @relation(fields: [secretWishId], references: [id], onDelete: Cascade)
  targetUser    User        @relation("RevealTarget", fields: [targetUserId], references: [id])
}

model DailyInteraction {
  id            String      @id @default(uuid())
  type          String
  date          String
  userId        String
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  user          User        @relation(fields: [userId], references: [id])

  @@unique([type, date, userId])
  @@index([coupleSpaceId, type, date])
}

model MissYou {
  id            String      @id @default(uuid())
  date          String
  count         Int         @default(1)
  userId        String
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  user          User        @relation(fields: [userId], references: [id])

  @@unique([date, userId])
  @@index([coupleSpaceId, date])
}

model FoodLibrary {
  id            String       @id @default(uuid())
  name          String
  emoji         String       @default("üìÇ")
  description   String?
  coupleSpaceId String
  createdById   String?
  isDefault     Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  coupleSpace   CoupleSpace  @relation(fields: [coupleSpaceId], references: [id])
  foodOptions   FoodOption[]

  @@index([coupleSpaceId])
}

model FoodOption {
  id            String       @id @default(uuid())
  name          String
  emoji         String       @default("üçΩÔ∏è")
  category      String
  subCategory   String?
  tags          String[]
  isPreset      Boolean      @default(false)
  isActive      Boolean      @default(true)
  coupleSpaceId String
  createdById   String?
  libraryId     String?
  createdAt     DateTime     @default(now())
  coupleSpace   CoupleSpace  @relation(fields: [coupleSpaceId], references: [id])
  library       FoodLibrary? @relation(fields: [libraryId], references: [id], onDelete: SetNull)

  @@index([coupleSpaceId, isActive])
  @@index([coupleSpaceId, category])
  @@index([libraryId])
}

model FoodChoice {
  id            String      @id @default(uuid())
  foodName      String
  foodEmoji     String      @default("üçΩÔ∏è")
  category      String
  mode          String      @default("random")
  userARating   Int?
  userBRating   Int?
  note          String?
  coupleSpaceId String
  chooserId     String?
  chosenDate    DateTime    @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])

  @@index([coupleSpaceId, chosenDate])
}

model FoodVoteSession {
  id            String      @id @default(uuid())
  status        String      @default("waiting")
  userAId       String?
  userBId       String?
  userAChoice   String[]
  userBChoice   String[]
  matchedResult String[]
  finalChoice   String?
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  expiresAt     DateTime
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])

  @@index([coupleSpaceId, status])
  @@index([coupleSpaceId, createdAt])
}
