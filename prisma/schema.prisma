generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model CoupleSpace {
  id             String        @id @default(uuid())
  passphraseHash String        @unique
  inviteCode     String?       @unique  // 6ä½é‚€è¯·ç»‘å®šç ï¼Œå¯ç©ºç”¨äºè¿ç§»
  startDate      DateTime?
  theme          String        @default("yellow")
  effectIntensity String       @default("subtle")   // æ•ˆæœå¼ºåº¦: subtle | obvious
  effectArea      String       @default("local")    // æ•ˆæœèŒƒå›´: local | fullpage
  createdAt      DateTime      @default(now())
  users          User[]
  moments        Moment[]
  wishes         Wish[]
  anniversaries  Anniversary[]
  secretWishes   SecretWish[]
  revealRequests WishRevealRequest[]
  dailyInteractions DailyInteraction[]
  missYouRecords    MissYou[]
}

model User {
  id                  String              @id @default(uuid())
  nickname            String
  displayName         String?
  passwordHash        String?             // ç”¨æˆ·å¯†ç å“ˆå¸Œï¼Œå¯ç©ºä»¥å…¼å®¹è€ç”¨æˆ·
  gender              String?
  avatarEmoji         String              @default("ğŸ’•")
  avatarUrl           String?
  status              String              @default("")
  isProfileComplete   Boolean             @default(false)
  email               String?             @unique  // é‚®ç®±åœ°å€ï¼Œå”¯ä¸€çº¦æŸ
  isEmailVerified     Boolean             @default(false)  // é‚®ç®±æ˜¯å¦å·²éªŒè¯
  // é€šçŸ¥è®¾ç½®ï¼ˆé»˜è®¤å…³é—­ï¼‰
  notifyOnMoment            Boolean             @default(false)  // ä¼´ä¾£å‘æ—¥è®°æ—¶é€šçŸ¥
  notifyOnComment           Boolean             @default(false)  // ä¼´ä¾£è¯„è®ºæ—¶é€šçŸ¥
  notifyOnWish              Boolean             @default(false)  // ä¼´ä¾£å‘å¿ƒæ„¿æ—¶é€šçŸ¥
  notifyOnSecretWishRequest Boolean             @default(true)   // ä¼´ä¾£è¯·æ±‚æŸ¥çœ‹ç§˜å¯†å¿ƒæ„¿æ—¶é€šçŸ¥
  notifyOnSecretWishResponse Boolean            @default(true)   // ä¼´ä¾£åŒæ„/æ‹’ç»æŸ¥çœ‹è¯·æ±‚æ—¶é€šçŸ¥
  coupleSpaceId       String
  createdAt           DateTime            @default(now())
  coupleSpace         CoupleSpace         @relation(fields: [coupleSpaceId], references: [id])
  moments             Moment[]
  comments            Comment[]
  reactions           Reaction[]
  wishesCreated       Wish[]              @relation("WishCreator")
  wishesEdited        Wish[]              @relation("WishEditor")
  wishVotes           WishVote[]
  wishComments        WishComment[]
  emailVerifications  EmailVerification[]
  secretWishes        SecretWish[]
  revealRequestsSent  WishRevealRequest[] @relation("RevealRequester")
  revealRequestsReceived WishRevealRequest[] @relation("RevealTarget")
  dailyInteractions   DailyInteraction[]
  missYouRecords       MissYou[]
  
  @@unique([coupleSpaceId, nickname])
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String   // 6ä½æ•°å­—éªŒè¯ç 
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([email, code])
}

model Moment {
  id            String      @id @default(uuid())
  content       String
  mediaUrl      String?
  mediaType     String      @default("none")
  likeCount     Int         @default(0)  // ç‚¹èµæ¬¡æ•°ï¼ˆå¯å¤šæ¬¡ç‚¹å‡»ï¼‰
  userId        String
  coupleSpaceId String
  momentDate    DateTime
  createdAt     DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id])
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  comments      Comment[]
  reactions     Reaction[]
  
  @@unique([userId, momentDate])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  momentId  String
  userId    String
  parentId  String?
  createdAt DateTime  @default(now())
  moment    Moment    @relation(fields: [momentId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
}

model Reaction {
  id        String   @id @default(uuid())
  emoji     String
  momentId  String
  userId    String
  createdAt DateTime @default(now())
  moment    Moment   @relation(fields: [momentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  
  @@unique([momentId, userId, emoji])
}

model Wish {
  id             String        @id @default(uuid())
  content        String
  isCompleted    Boolean       @default(false)
  coupleSpaceId  String
  createdById    String
  lastEditedById String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  coupleSpace    CoupleSpace   @relation(fields: [coupleSpaceId], references: [id])
  createdBy      User          @relation("WishCreator", fields: [createdById], references: [id])
  lastEditedBy   User?         @relation("WishEditor", fields: [lastEditedById], references: [id])
  votes          WishVote[]
  comments       WishComment[]
}

model WishVote {
  id        String   @id @default(uuid())
  wishId    String
  userId    String
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  wish      Wish     @relation(fields: [wishId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  
  @@unique([wishId, userId])
}

model WishComment {
  id        String        @id @default(uuid())
  content   String
  wishId    String
  userId    String
  parentId  String?
  createdAt DateTime      @default(now())
  wish      Wish          @relation(fields: [wishId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])
  parent    WishComment?  @relation("WishCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   WishComment[] @relation("WishCommentReplies")
}

// æœŸç›¼ - é‡è¦æ—¥æœŸ/çºªå¿µæ—¥
model Anniversary {
  id            String      @id @default(uuid())
  title         String      // æ ‡é¢˜ï¼Œå¦‚"åœ¨ä¸€èµ·"ã€"ç”Ÿæ—¥"
  date          DateTime    // æ—¥æœŸ
  emoji         String      @default("ğŸ’•")  // æ˜¾ç¤ºå›¾æ ‡
  type          String      @default("countdown")  // countdown(å€’è®¡æ—¶) æˆ– countup(å·²è¿‡å¤©æ•°)
  isRecurring   Boolean     @default(false)  // æ˜¯å¦æ¯å¹´é‡å¤
  isPinned      Boolean     @default(false)  // æ˜¯å¦ç½®é¡¶ä¼˜å…ˆæ˜¾ç¤º
  sortOrder     Int         @default(0)  // è‡ªå®šä¹‰æ’åºé¡ºåº
  coupleSpaceId String
  createdById   String
  createdAt     DateTime    @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
}

// ç§˜å¯†å¿ƒæ„¿ - ä¸ªäººç§å¯†å¿ƒæ„¿
model SecretWish {
  id            String    @id @default(uuid())
  content       String    // å¿ƒæ„¿å†…å®¹
  emoji         String    @default("ğŸ")
  isRevealed    Boolean   @default(false)  // æ˜¯å¦å·²æ­ç¤ºç»™ä¼´ä¾£
  revealedAt    DateTime? // æ­ç¤ºæ—¶é—´
  coupleSpaceId String
  createdById   String
  createdAt     DateTime  @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  createdBy     User @relation(fields: [createdById], references: [id])
  revealRequests WishRevealRequest[]
}

// å¿ƒæ„¿æ­ç¤ºè¯·æ±‚
model WishRevealRequest {
  id            String    @id @default(uuid())
  secretWishId  String?   // nullè¡¨ç¤ºéšæœºè¯·æ±‚
  requesterId   String    // è¯·æ±‚è€…
  targetUserId  String    // è¢«è¯·æ±‚è€…ï¼ˆå¿ƒæ„¿æ‹¥æœ‰è€…ï¼‰
  status        String    @default("pending") // pending/approved/rejected
  coupleSpaceId String
  createdAt     DateTime  @default(now())
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  secretWish    SecretWish? @relation(fields: [secretWishId], references: [id], onDelete: Cascade)
  requester     User @relation("RevealRequester", fields: [requesterId], references: [id])
  targetUser    User @relation("RevealTarget", fields: [targetUserId], references: [id])
}

// æ¯æ—¥äº’åŠ¨ï¼ˆäº²äº²/æ™šå®‰æ‰“å¡ï¼‰
model DailyInteraction {
  id            String      @id @default(uuid())
  type          String      // "kiss" æˆ– "goodnight"
  date          String      // æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
  userId        String
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id])
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  
  @@unique([type, date, userId])  // æ¯äººæ¯å¤©æ¯ç±»å‹åªèƒ½ä¸€æ¬¡
  @@index([coupleSpaceId, type, date])
}

// æƒ³ä½ è®°å½•ï¼ˆæ¯æ—¥ç‚¹å‡»ä¼´ä¾£å¤´åƒç´¯è®¡ï¼‰
model MissYou {
  id            String      @id @default(uuid())
  date          String      // æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
  count         Int         @default(1)  // æƒ³ä½ æ¬¡æ•°
  userId        String      // å‘èµ·è€…ï¼ˆç‚¹å‡»çš„äººï¼‰
  coupleSpaceId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id])
  coupleSpace   CoupleSpace @relation(fields: [coupleSpaceId], references: [id])
  
  @@unique([date, userId])  // æ¯äººæ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
  @@index([coupleSpaceId, date])
}
